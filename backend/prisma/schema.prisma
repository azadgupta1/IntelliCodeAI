generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int      @id @default(autoincrement())
  username          String   @unique
  email             String   @unique
  githubId          String?  @unique
  githubAccessToken String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  avatarUrl         String?
  bio               String?

  files       File[] // One-to-many relation with File
  analysis    Analysis[] // One-to-many relation with Analysis
  githubRepos GithubRepo[] // One-to-many relation with GithubRepo

  Notification Notification[]
}

model File {
  id         Int      @id @default(autoincrement())
  userId     Int? // Optional, allows anonymous uploads
  filename   String
  fileUrl    String   @unique
  uploadedAt DateTime @default(now())

  user     User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  analysis Analysis? @relation(name: "FileToAnalysis")
}

model Analysis {
  id         Int      @id @default(autoincrement())
  fileId     Int?     @unique
  result     Json
  commitHash String
  createdAt  DateTime @default(now())

  file         File?       @relation(name: "FileToAnalysis", fields: [fileId], references: [id], onDelete: Cascade)
  filePath         String?
  userId       Int? // Allow anonymous analysis
  user         User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  // âœ… New relation: An analysis belongs to a repo
  githubRepoId Int?
  githubRepo   GithubRepo? @relation(name: "RepoToAnalysis", fields: [githubRepoId], references: [id], onDelete: Cascade)

  errorCnt        Int @default(0)
  suggestionCnt   Int @default(0)
  optimizationCnt Int @default(0)

  ignored    Boolean @default(false)
  isCommited Boolean @default(false)

  originalCode String?
  fixedCode    String?
}

model GithubRepo {
  id          Int      @id @default(autoincrement())
  userId      Int
  repoName    String
  repoUrl     String   @unique
  createdAt   DateTime @default(now())
  ownerName   String
  webhookId   String? // Store GitHub Webhook ID if auto-analysis is enabled
  autoAnalyze Boolean  @default(false)

  analyses Analysis[] @relation(name: "RepoToAnalysis")

  errorCount Int @default(0) // ðŸ†• Added this line

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  defaultBranch String?
  branches      String[]

  lastSyncedAt DateTime?
  lastCommitAt DateTime?

  @@unique([repoName, userId])
  RepoErrorHistory RepoErrorHistory[]
}


model RepoErrorHistory {
  id         Int      @id @default(autoincrement())
  repoId     Int
  errorCount Int
  timestamp  DateTime @default(now())

  repo GithubRepo @relation(fields: [repoId], references: [id], onDelete: Cascade)

  @@index([repoId, timestamp])
}



model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
